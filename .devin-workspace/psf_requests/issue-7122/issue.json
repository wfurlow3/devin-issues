{
  "title": "Unable to override cookie policy in Session.prepare_request",
  "body": "If you set a CookiePolicy on the cookie jar of a Session object, it is ignored. This has previously been reported (#3416) and fixed (#4042) ...except that the fix was merged into a `proposed/3.0.0` branch that has been abandoned since 2018.\n\nThis issue continues to walk the earth, tripping up unwary devs. Today it was my turn (I'm writing tests for an app that uses `secure` session cookies on localhost: this is fine in browsers, but not allowed by `http.cookiejar.DefaultCookiePolicy`. I attempted to override that policy, and...here we are.)\n\nThe route to a fix seems pretty straightforward - I started sketching something up, and realised that the patch from #4042 is ~directly applicable to the present codebase. It's already been approved, so I'm hoping this is an easy win!\n\n\n## Expected Result\n\nWhen calling `session.cookie.set_policy(policy)`, that policy is honoured.\n\n## Actual Result\n\nThe policy is discarded and a `DefaultCookiePolicy` is used.\n\n## Reproduction Steps\n\nSlightly adapting the code from #3416:\n\n```python\nimport requests\nimport http.cookiejar\n\nclass MyCustomCookiePolicy(http.cookiejar.DefaultCookiePolicy):\n    def return_ok_secure(self, cookie, request):\n        print(\"Custom cookie policy got to examine this request\")\n        # Allow secure cookies on localhost\n        if request.host in ('localhost', '127.0.0.1', 'localhost.local'):\n            return True\n        return super().return_ok_secure(cookie, request)\n\n\ns = requests.Session()\ns.cookies = requests.cookies.RequestsCookieJar(policy=MyCustomCookiePolicy())\ns.get('https://google.com') # Put some cookies in the jar\nassert len(s.cookies) > 0 # Verify that they arrived\nr = requests.Request('GET', 'https://google.com')\npr = s.prepare_request(r)\n# Observe that the `print()` statement above failed to fire: The cookie policy was not consulted!\n\n```\n\n## System Information\n\n    $ python -m requests.help\n\n```json\n{\n  \"chardet\": {\n    \"version\": null\n  },\n  \"charset_normalizer\": {\n    \"version\": \"3.4.2\"\n  },\n  \"cryptography\": {\n    \"version\": \"\"\n  },\n  \"idna\": {\n    \"version\": \"3.10\"\n  },\n  \"implementation\": {\n    \"name\": \"CPython\",\n    \"version\": \"3.10.12\"\n  },\n  \"platform\": {\n    \"release\": \"6.8.0-87-generic\",\n    \"system\": \"Linux\"\n  },\n  \"pyOpenSSL\": {\n    \"openssl_version\": \"\",\n    \"version\": null\n  },\n  \"requests\": {\n    \"version\": \"2.32.4\"\n  },\n  \"system_ssl\": {\n    \"version\": \"300000d0\"\n  },\n  \"urllib3\": {\n    \"version\": \"2.5.0\"\n  },\n  \"using_charset_normalizer\": true,\n  \"using_pyopenssl\": false\n}\n```\n",
  "number": 7122,
  "url": "https://github.com/psf/requests/issues/7122"
}